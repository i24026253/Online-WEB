<!--reports.html-->

{% extends 'base.html' %}
{% load static %}

{% block title %}Attendance Report - Attendance System{% endblock %}

{% block authenticated_content %}
<div class="container-fluid">
    <h1 class="h2 mb-4"><i class="fas fa-file-alt me-2"></i>Attendance Report</h1>
    
    <!-- Filtering -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filter</h5>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Time period</label>
                    <select name="period" class="form-select">
                        <option value="daily" {% if period == 'daily' %}selected{% endif %}>Daily</option>
                        <option value="weekly" {% if period == 'weekly' %}selected{% endif %}>Weekly</option>
                        <option value="monthly" {% if period == 'monthly' %}selected{% endif %}>Monthly</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Start Sate</label>
                    <input type="date" name="start" class="form-control" value="{{ start }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">End Date</label>
                    <input type="date" name="end" class="form-control" value="{{ end }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary d-block w-100">
                        <i class="fas fa-search me-2"></i>Generate Reports
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Summary Information Card -->
    {% if report_data.summary %}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <i class="fas fa-list fa-3x text-primary mb-3"></i>
                    <h3>{{ report_data.summary.total_records }}</h3>
                    <p class="text-muted mb-0">Total number of records</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <i class="fas fa-percentage fa-3x text-success mb-3"></i>
                    <h3>{{ report_data.summary.avg_percentage }}%</h3>
                    <p class="text-muted mb-0">Average attendance rate</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Report Data - Table -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-table me-2"></i>Report Details</h5>
            <span class="badge bg-info">{{ period|upper }}</span>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th><i class="fas fa-user me-1"></i>Student</th>
                            <th><i class="fas fa-book me-1"></i>Course</th>
                            <th><i class="fas fa-calendar me-1"></i>Date</th>
                            <th><i class="fas fa-check-circle me-1"></i>Stattus</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in report_data %}
                            {% if item.student_name %}
                            <tr>
                                <td>{{ item.student_name }}</td>
                                <td>{{ item.CourseName }}</td>
                                <td>{{ item.SessionDate }}</td>
                                <td>
                                    <span class="badge {% if item.Status == 'Present' %}bg-success{% elif item.Status == 'Absent' %}bg-danger{% elif item.Status == 'Late' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                                        {% if item.Status == 'Present' %}
                                            <i class="fas fa-check me-1"></i>
                                        {% elif item.Status == 'Absent' %}
                                            <i class="fas fa-times me-1"></i>
                                        {% elif item.Status == 'Late' %}
                                            <i class="fas fa-clock me-1"></i>
                                        {% endif %}
                                        {{ item.Status }}
                                    </span>
                                </td>
                            </tr>
                            {% endif %}
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center py-5">
                                <i class="fas fa-inbox fa-3x text-muted mb-3 d-block"></i>
                                <p class="text-muted mb-0">No records were recorded during this time period.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Export button -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="fas fa-download me-2"></i>Export Report</h5>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">Select the format to export the report data</p>
            <div class="btn-group" role="group">
                <a href="http://localhost:8080/php_module/export.php?format=pdf&period={{ period }}{% if start %}&start={{ start }}{% endif %}{% if end %}&end={{ end }}{% endif %}{% if course_id %}&course_id={{ course_id }}{% endif %}{% if student_id %}&student_id={{ student_id }}{% endif %}" 
                   class="btn btn-danger" target="_blank">
                    <i class="fas fa-file-pdf me-2"></i>Export PDF
                </a>
                <a href="http://localhost:8080/php_module/export.php?format=excel&period={{ period }}{% if start %}&start={{ start }}{% endif %}{% if end %}&end={{ end }}{% endif %}{% if course_id %}&course_id={{ course_id }}{% endif %}{% if student_id %}&student_id={{ student_id }}{% endif %}" 
                   class="btn btn-success" target="_blank">
                    <i class="fas fa-file-excel me-2"></i>Export Excel
                </a>
                <a href="http://localhost:8080/php_module/export.php?format=csv&period={{ period }}{% if start %}&start={{ start }}{% endif %}{% if end %}&end={{ end }}{% endif %}{% if course_id %}&course_id={{ course_id }}{% endif %}{% if student_id %}&student_id={{ student_id }}{% endif %}" 
                   class="btn btn-info" target="_blank">
                    <i class="fas fa-file-csv me-2"></i>Export CSV
                </a>
            </div>
            <small class="d-block mt-2 text-muted">
                <i class="fas fa-info-circle me-1"></i>The export function will open in a new tab and automatically download the file.
            </small>
        </div>
    </div>
    
    <!-- Visualization chart -->
    {% if report_data.summary %}
        {% if report_data.summary.total_records > 0 %}
    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Attendance Trends</h5>
        </div>
        <div class="card-body">
            <canvas id="reportChart" height="80"></canvas>
        </div>
    </div>
        {% endif %}
    {% endif %}
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% if report_data.summary %}
    {% if report_data.summary.total_records > 0 %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var ctx = document.getElementById('reportChart');
        if (ctx) {
            var avgPercentage = parseFloat('{{ report_data.summary.avg_percentage|default:"0" }}') || 0;
            
            new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: { 
                    labels: ['平均出勤率'], 
                    datasets: [{
                        label: '百分比',
                        data: [avgPercentage], 
                        backgroundColor: '#1abc9c',
                        borderColor: '#16a085',
                        borderWidth: 2
                    }] 
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        } 
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Attendance: ' + context.parsed.y + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
    });
</script>
    {% endif %}
{% endif %}

<style>
.card {
    border: none;
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-5px);
}

.btn-group .btn {
    transition: all 0.3s;
}

.btn-group .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.table thead th {
    background-color: #f8f9fa;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
}

.badge {
    padding: 0.5em 0.75em;
    font-size: 0.875rem;
}
</style>
{% endblock %}